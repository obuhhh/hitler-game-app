<!DOCTYPE html>
<html lang="uk">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Таємний Гітлер</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --tg-theme-bg-color: #1a202c;
            --tg-theme-text-color: #e2e8f0;
            --tg-theme-button-color: #4a5568;
            --tg-theme-button-text-color: #e2e8f0;
        }

        body {
            background-color: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            margin: 0;
        }

        .policy-card {
            border: 2px solid;
        }

        .liberal {
            border-color: #4299e1;
            background-color: #2b6cb0;
        }

        .fascist {
            border-color: #e53e3e;
            background-color: #c53030;
        }

        .policy-card.empty {
            background-color: #2d3748;
            border-color: #4a5568;
        }

        .player-card {
            background-color: #2d3748;
        }

        .action-button {
            background-color: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
            transition: all 0.2s;
            border: 2px solid transparent;
        }

        .action-button.selected {
            border-color: #63b3ed;
            transform: scale(1.05);
        }
    </style>
</head>

<body class="p-4">

    <div id="main-container" class="max-w-md mx-auto">
        <header class="text-center mb-4">
            <h1 class="text-2xl font-bold">Таємний Гітлер</h1>
            <p id="user-info" class="text-sm text-gray-400">Завантаження...</p>
        </header>

        <!-- Ігрове поле (статичне для прикладу) -->
        <section id="game-board" class="mb-6">
            <!-- ... (код ігрового поля без змін) ... -->
        </section>

        <!-- Гравці (буде заповнено динамічно) -->
        <section id="players-section" class="mb-6">
            <h2 class="text-lg font-semibold mb-2">Гравці</h2>
            <div id="players-list" class="space-y-2">
                <p class="text-gray-400">Очікування даних про гравців...</p>
            </div>
        </section>

        <!-- Панель дій -->
        <section id="actions">
            <h2 class="text-lg font-semibold mb-2">Ваші дії</h2>
            <div class="grid grid-cols-2 gap-4">
                <button id="vote-ja-btn" class="action-button p-4 rounded-lg font-bold text-green-400">Голосувати
                    "Ja!"</button>
                <button id="vote-nein-btn" class="action-button p-4 rounded-lg font-bold text-red-400">Голосувати
                    "Nein!"</button>
            </div>
        </section>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        let selectedAction = null;

        // Функція для рендерингу списку гравців
        function renderPlayers(players) {
            const playersListDiv = document.getElementById('players-list');
            playersListDiv.innerHTML = '';
            if (!players || players.length === 0) {
                playersListDiv.innerHTML = '<p class="text-gray-400">Ще немає гравців.</p>';
                return;
            }
            players.forEach(player => {
                const playerDiv = document.createElement('div');
                playerDiv.className = 'player-card p-3 rounded-lg flex justify-between items-center';
                playerDiv.innerHTML = `<span>${player.full_name}</span> <span class="text-xs text-gray-400">ID: ${player.user_id}</span>`;
                playersListDiv.appendChild(playerDiv);
            });
        }

        // Логіка для кнопок
        function prepareAction(action, value, buttonText) {
            selectedAction = { action, value };
            tg.MainButton.setText(buttonText);
            tg.MainButton.show();

            document.getElementById('vote-ja-btn').classList.remove('selected');
            document.getElementById('vote-nein-btn').classList.remove('selected');
            if (value === 'ja') {
                document.getElementById('vote-ja-btn').classList.add('selected');
            } else {
                document.getElementById('vote-nein-btn').classList.add('selected');
            }
        }

        // --- ОНОВЛЕНИЙ ОБРОБНИК ГОЛОВНОЇ КНОПКИ (З НАДІЙНИМ ЗАКРИТТЯМ) ---
        tg.onEvent('mainButtonClicked', function () {
            // Перевіряємо, чи була обрана дія
            if (!selectedAction) {
                tg.showAlert("Помилка: дія не обрана. Будь ласка, натисніть 'Ja!' або 'Nein!' ще раз.");
                return;
            }

            try {
                const jsonString = JSON.stringify(selectedAction);

                // 1. Надсилаємо дані боту
                tg.sendData(jsonString);

                // 2. Явно закриваємо Mini App.
                // Документація каже, що sendData закриває додаток, але явний виклик 
                // tg.close() часто вирішує проблеми на різних клієнтах Telegram.
                // Після цього виклику вікно має закритися, а дані — надійти на бекенд.
                tg.close();

            } catch (e) {
                // Цей блок спрацює, якщо виникне помилка в самому JavaScript
                console.error("Помилка в обробнику mainButtonClicked:", e);
                tg.showAlert(`Критична помилка на стороні клієнта: ${e.message}`);
            }
        });


        // Головна функція ініціалізації
        function initializeApp() {
            try {
                tg.ready();
                tg.expand();

                const userInfo = document.getElementById('user-info');
                if (tg.initDataUnsafe.user) {
                    userInfo.textContent = `Гравець: ${tg.initDataUnsafe.user.first_name}`;
                }

                const urlParams = new URLSearchParams(window.location.search);
                const gameStateParam = urlParams.get('game_state');
                if (gameStateParam) {
                    const decodedGameState = decodeURIComponent(gameStateParam);
                    const gameState = JSON.parse(decodedGameState);
                    renderPlayers(gameState.players);
                } else {
                    renderPlayers([]);
                }
            } catch (e) {
                console.error("Помилка ініціалізації:", e);
                tg.showAlert(`Помилка ініціалізації: ${e.message}`);
            }
        }

        // Обробники кнопок
        document.getElementById('vote-ja-btn').addEventListener('click', () => prepareAction('vote', 'ja', 'Підтвердити: Ja!'));
        document.getElementById('vote-nein-btn').addEventListener('click', () => prepareAction('vote', 'nein', 'Підтвердити: Nein!'));

        // Запускаємо ініціалізацію
        initializeApp();
    </script>
</body>

</html>